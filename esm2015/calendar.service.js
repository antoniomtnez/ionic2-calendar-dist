import { __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
let CalendarService = class CalendarService {
    constructor() {
        this.currentDateChangedFromParent = new Subject();
        this.currentDateChangedFromChildren = new Subject();
        this.eventSourceChanged = new Subject();
        this.slideChanged = new Subject();
        this.slideUpdated = new Subject();
        this.currentDateChangedFromParent$ = this.currentDateChangedFromParent.asObservable();
        this.currentDateChangedFromChildren$ = this.currentDateChangedFromChildren.asObservable();
        this.eventSourceChanged$ = this.eventSourceChanged.asObservable();
        this.slideChanged$ = this.slideChanged.asObservable();
        this.slideUpdated$ = this.slideUpdated.asObservable();
    }
    setCurrentDate(val, fromParent = false) {
        this._currentDate = new Date(val);
        if (fromParent) {
            this.currentDateChangedFromParent.next(val);
        }
        else {
            this.currentDateChangedFromChildren.next(val);
        }
    }
    get currentDate() {
        return this._currentDate;
    }
    rangeChanged(component) {
        if (this.queryMode === 'local') {
            if (component.eventSource && component.onDataLoaded) {
                component.onDataLoaded();
            }
        }
        else if (this.queryMode === 'remote') {
            let rangeStart = new Date(component.range.startTime.getTime()), rangeEnd = new Date(component.range.endTime.getTime());
            rangeStart.setHours(0);
            if (rangeStart.getHours() === 23) {
                rangeStart.setTime(rangeStart.getTime() + 3600000);
            }
            rangeEnd.setHours(0);
            if (rangeEnd.getHours() === 23) {
                rangeEnd.setTime(rangeEnd.getTime() + 3600000);
            }
            component.onRangeChanged.emit({
                startTime: rangeStart,
                endTime: rangeEnd
            });
        }
    }
    getStep(mode) {
        switch (mode) {
            case 'month':
                return {
                    years: 0,
                    months: 1,
                    days: 0
                };
            case 'week':
                return {
                    years: 0,
                    months: 0,
                    days: 7
                };
            case 'day':
                return {
                    years: 0,
                    months: 0,
                    days: 1
                };
        }
    }
    getAdjacentCalendarDate(mode, direction) {
        let calculateCalendarDate = this.currentDate;
        const step = this.getStep(mode), year = calculateCalendarDate.getFullYear() + direction * step.years, month = calculateCalendarDate.getMonth() + direction * step.months, date = calculateCalendarDate.getDate() + direction * step.days;
        calculateCalendarDate = new Date(year, month, date, 12, 0, 0);
        if (mode === 'month') {
            const firstDayInNextMonth = new Date(year, month + 1, 1, 12, 0, 0);
            if (firstDayInNextMonth.getTime() <= calculateCalendarDate.getTime()) {
                calculateCalendarDate = new Date(firstDayInNextMonth.getTime() - 24 * 60 * 60 * 1000);
            }
        }
        return calculateCalendarDate;
    }
    getAdjacentViewStartTime(component, direction) {
        let adjacentCalendarDate = this.getAdjacentCalendarDate(component.mode, direction);
        return component.getRange(adjacentCalendarDate).startTime;
    }
    populateAdjacentViews(component) {
        let currentViewStartDate, currentViewData, toUpdateViewIndex, currentViewIndex = component.currentViewIndex;
        if (component.direction === 1) {
            currentViewStartDate = this.getAdjacentViewStartTime(component, 1);
            toUpdateViewIndex = (currentViewIndex + 1) % 3;
            component.views[toUpdateViewIndex] = component.getViewData(currentViewStartDate);
        }
        else if (component.direction === -1) {
            currentViewStartDate = this.getAdjacentViewStartTime(component, -1);
            toUpdateViewIndex = (currentViewIndex + 2) % 3;
            component.views[toUpdateViewIndex] = component.getViewData(currentViewStartDate);
        }
        else {
            if (!component.views) {
                currentViewData = [];
                currentViewStartDate = component.range.startTime;
                currentViewData.push(component.getViewData(currentViewStartDate));
                currentViewStartDate = this.getAdjacentViewStartTime(component, 1);
                currentViewData.push(component.getViewData(currentViewStartDate));
                currentViewStartDate = this.getAdjacentViewStartTime(component, -1);
                currentViewData.push(component.getViewData(currentViewStartDate));
                component.views = currentViewData;
            }
            else {
                currentViewStartDate = component.range.startTime;
                component.views[currentViewIndex] = component.getViewData(currentViewStartDate);
                currentViewStartDate = this.getAdjacentViewStartTime(component, -1);
                toUpdateViewIndex = (currentViewIndex + 2) % 3;
                component.views[toUpdateViewIndex] = component.getViewData(currentViewStartDate);
                currentViewStartDate = this.getAdjacentViewStartTime(component, 1);
                toUpdateViewIndex = (currentViewIndex + 1) % 3;
                component.views[toUpdateViewIndex] = component.getViewData(currentViewStartDate);
            }
        }
    }
    loadEvents() {
        this.eventSourceChanged.next();
    }
    slide(direction) {
        this.slideChanged.next(direction);
    }
    update() {
        this.slideUpdated.next();
    }
};
CalendarService = __decorate([
    Injectable()
], CalendarService);
export { CalendarService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FsZW5kYXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2lvbmljMi1jYWxlbmRhci8iLCJzb3VyY2VzIjpbImNhbGVuZGFyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDekMsT0FBTyxFQUFhLE9BQU8sRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUt6QyxJQUFhLGVBQWUsR0FBNUIsTUFBYSxlQUFlO0lBZXhCO1FBTlEsaUNBQTRCLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUNuRCxtQ0FBOEIsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDO1FBQ3JELHVCQUFrQixHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7UUFDekMsaUJBQVksR0FBRyxJQUFJLE9BQU8sRUFBVSxDQUFDO1FBQ3JDLGlCQUFZLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUd2QyxJQUFJLENBQUMsNkJBQTZCLEdBQUcsSUFBSSxDQUFDLDRCQUE0QixDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ3RGLElBQUksQ0FBQywrQkFBK0IsR0FBRyxJQUFJLENBQUMsOEJBQThCLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDMUYsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNsRSxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDdEQsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQzFELENBQUM7SUFFRCxjQUFjLENBQUMsR0FBUyxFQUFFLGFBQXNCLEtBQUs7UUFDakQsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNsQyxJQUFJLFVBQVUsRUFBRTtZQUNaLElBQUksQ0FBQyw0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Q0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDcEUsaUJBQWlCLEdBQUcsQ0FBQyxnQkFBZ0IsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQy9DLFNBQVMsQ0FBQyxLQUFLLENBQUMsaUJBQWlCLENBQUMsR0FBRyxTQUFTLENBQUMsV0FBVyxDQUFDLG9CQUFvQixDQUFDLENBQUM7Z0JBQ2pGLG9CQUFvQixHQUFHLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ25FLGlCQUFpQixHQUFHLENBQUMsZ0JBQWdCLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUMvQyxTQUFTLENBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLEdBQUcsU0FBUyxDQUFDLFdBQVcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO2FBQ3BGO1NBQ0o7SUFDTCxDQUFDO0lBRUQsVUFBVTtRQUNOLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNuQyxDQUFDO0lBRUQsS0FBSyxDQUFDLFNBQWlCO1FBQ25CLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3RDLENBQUM7SUFFRCxNQUFNO1FBQ0YsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUM3QixDQUFDO0NBQ0osQ0FBQTtBQTNKWSxlQUFlO0lBRDNCLFVBQVUsRUFBRTtHQUNBLGVBQWUsQ0EySjNCO1NBM0pZLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0luamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQge09ic2VydmFibGUsIFN1YmplY3R9IGZyb20gJ3J4anMnO1xyXG5cclxuaW1wb3J0IHtJQ2FsZW5kYXJDb21wb25lbnQsIElWaWV3LCBDYWxlbmRhck1vZGUsIFF1ZXJ5TW9kZX0gZnJvbSAnLi9jYWxlbmRhcic7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBDYWxlbmRhclNlcnZpY2Uge1xyXG4gICAgcXVlcnlNb2RlOiBRdWVyeU1vZGU7XHJcbiAgICBjdXJyZW50RGF0ZUNoYW5nZWRGcm9tUGFyZW50JDogT2JzZXJ2YWJsZTxEYXRlPjtcclxuICAgIGN1cnJlbnREYXRlQ2hhbmdlZEZyb21DaGlsZHJlbiQ6IE9ic2VydmFibGU8RGF0ZT47XHJcbiAgICBldmVudFNvdXJjZUNoYW5nZWQkOiBPYnNlcnZhYmxlPHZvaWQ+O1xyXG4gICAgc2xpZGVDaGFuZ2VkJDogT2JzZXJ2YWJsZTxudW1iZXI+O1xyXG4gICAgc2xpZGVVcGRhdGVkJDogT2JzZXJ2YWJsZTx2b2lkPjtcclxuXHJcbiAgICBwcml2YXRlIF9jdXJyZW50RGF0ZTogRGF0ZTtcclxuICAgIHByaXZhdGUgY3VycmVudERhdGVDaGFuZ2VkRnJvbVBhcmVudCA9IG5ldyBTdWJqZWN0PERhdGU+KCk7XHJcbiAgICBwcml2YXRlIGN1cnJlbnREYXRlQ2hhbmdlZEZyb21DaGlsZHJlbiA9IG5ldyBTdWJqZWN0PERhdGU+KCk7XHJcbiAgICBwcml2YXRlIGV2ZW50U291cmNlQ2hhbmdlZCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XHJcbiAgICBwcml2YXRlIHNsaWRlQ2hhbmdlZCA9IG5ldyBTdWJqZWN0PG51bWJlcj4oKTtcclxuICAgIHByaXZhdGUgc2xpZGVVcGRhdGVkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICB0aGlzLmN1cnJlbnREYXRlQ2hhbmdlZEZyb21QYXJlbnQkID0gdGhpcy5jdXJyZW50RGF0ZUNoYW5nZWRGcm9tUGFyZW50LmFzT2JzZXJ2YWJsZSgpO1xyXG4gICAgICAgIHRoaXMuY3VycmVudERhdGVDaGFuZ2VkRnJvbUNoaWxkcmVuJCA9IHRoaXMuY3VycmVudERhdGVDaGFuZ2VkRnJvbUNoaWxkcmVuLmFzT2JzZXJ2YWJsZSgpO1xyXG4gICAgICAgIHRoaXMuZXZlbnRTb3VyY2VDaGFuZ2VkJCA9IHRoaXMuZXZlbnRTb3VyY2VDaGFuZ2VkLmFzT2JzZXJ2YWJsZSgpO1xyXG4gICAgICAgIHRoaXMuc2xpZGVDaGFuZ2VkJCA9IHRoaXMuc2xpZGVDaGFuZ2VkLmFzT2JzZXJ2YWJsZSgpO1xyXG4gICAgICAgIHRoaXMuc2xpZGVVcGRhdGVkJCA9IHRoaXMuc2xpZGVVcGRhdGVkLmFzT2JzZXJ2YWJsZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHNldEN1cnJlbnREYXRlKHZhbDogRGF0ZSwgZnJvbVBhcmVudDogYm9vbGVhbiA9IGZhbHNlKSB7XHJcbiAgICAgICAgdGhpcy5fY3VycmVudERhdGUgPSBuZXcgRGF0ZSh2YWwpO1xyXG4gICAgICAgIGlmIChmcm9tUGFyZW50KSB7XHJcbiAgICAgICAgICAgIHRoaXMuY3VycmVudERhdGVDaGFuZ2VkRnJvbVBhcmVudC5uZXh0KHZhbCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5jdXJyZW50RGF0ZUNoYW5nZWRGcm9tQ2hpbGRyZW4ubmV4dCh2YWwpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXQgY3VycmVudERhdGUoKTogRGF0ZSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2N1cnJlbnREYXRlO1xyXG4gICAgfVxyXG5cclxuICAgIHJhbmdlQ2hhbmdlZChjb21wb25lbnQ6IElDYWxlbmRhckNvbXBvbmVudCkge1xyXG4gICAgICAgIGlmICh0aGlzLnF1ZXJ5TW9kZSA9PT0gJ2xvY2FsJykge1xyXG4gICAgICAgICAgICBpZiAoY29tcG9uZW50LmV2ZW50U291cmNlICYmIGNvbXBvbmVudC5vbkRhdGFMb2FkZWQpIHtcclxuICAgICAgICAgICAgICAgIGNvbXBvbmVudC5vbkRhdGFMb2FkZWQoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5xdWVyeU1vZGUgPT09ICdyZW1vdGUnKSB7XHJcbiAgICAgICAgICAgIGxldCByYW5nZVN0YXJ0ID0gbmV3IERhdGUoY29tcG9uZW50LnJhbmdlLnN0YXJ0VGltZS5nZXRUaW1lKCkpLFxyXG4gICAgICAgICAgICAgICAgcmFuZ2VFbmQgPSBuZXcgRGF0ZShjb21wb25lbnQucmFuZ2UuZW5kVGltZS5nZXRUaW1lKCkpO1xyXG5cclxuICAgICAgICAgICAgcmFuZ2VTdGFydC5zZXRIb3VycygwKTtcclxuICAgICAgICAgICAgaWYgKHJhbmdlU3RhcnQuZ2V0SG91cnMoKSA9PT0gMjMpIHtcclxuICAgICAgICAgICAgICAgIHJhbmdlU3RhcnQuc2V0VGltZShyYW5nZVN0YXJ0LmdldFRpbWUoKSArIDM2MDAwMDApO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByYW5nZUVuZC5zZXRIb3VycygwKTtcclxuICAgICAgICAgICAgaWYgKHJhbmdlRW5kLmdldEhvdXJzKCkgPT09IDIzKSB7XHJcbiAgICAgICAgICAgICAgICByYW5nZUVuZC5zZXRUaW1lKHJhbmdlRW5kLmdldFRpbWUoKSArIDM2MDAwMDApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbXBvbmVudC5vblJhbmdlQ2hhbmdlZC5lbWl0KHtcclxuICAgICAgICAgICAgICAgIHN0YXJ0VGltZTogcmFuZ2VTdGFydCxcclxuICAgICAgICAgICAgICAgIGVuZFRpbWU6IHJhbmdlRW5kXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldFN0ZXAobW9kZTogQ2FsZW5kYXJNb2RlKTogeyB5ZWFyczogbnVtYmVyOyBtb250aHM6IG51bWJlcjsgZGF5czogbnVtYmVyOyB9IHtcclxuICAgICAgICBzd2l0Y2ggKG1vZGUpIHtcclxuICAgICAgICAgICAgY2FzZSAnbW9udGgnOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICB5ZWFyczogMCxcclxuICAgICAgICAgICAgICAgICAgICBtb250aHM6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgZGF5czogMFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgY2FzZSAnd2Vlayc6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHllYXJzOiAwLFxyXG4gICAgICAgICAgICAgICAgICAgIG1vbnRoczogMCxcclxuICAgICAgICAgICAgICAgICAgICBkYXlzOiA3XHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBjYXNlICdkYXknOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICB5ZWFyczogMCxcclxuICAgICAgICAgICAgICAgICAgICBtb250aHM6IDAsXHJcbiAgICAgICAgICAgICAgICAgICAgZGF5czogMVxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0QWRqYWNlbnRDYWxlbmRhckRhdGUobW9kZTogQ2FsZW5kYXJNb2RlLCBkaXJlY3Rpb246IG51bWJlcik6IERhdGUge1xyXG4gICAgICAgIGxldCBjYWxjdWxhdGVDYWxlbmRhckRhdGUgPSB0aGlzLmN1cnJlbnREYXRlO1xyXG4gICAgICAgIGNvbnN0IHN0ZXAgPSB0aGlzLmdldFN0ZXAobW9kZSksXHJcbiAgICAgICAgICAgIHllYXIgPSBjYWxjdWxhdGVDYWxlbmRhckRhdGUuZ2V0RnVsbFllYXIoKSArIGRpcmVjdGlvbiAqIHN0ZXAueWVhcnMsXHJcbiAgICAgICAgICAgIG1vbnRoID0gY2FsY3VsYXRlQ2FsZW5kYXJEYXRlLmdldE1vbnRoKCkgKyBkaXJlY3Rpb24gKiBzdGVwLm1vbnRocyxcclxuICAgICAgICAgICAgZGF0ZSA9IGNhbGN1bGF0ZUNhbGVuZGFyRGF0ZS5nZXREYXRlKCkgKyBkaXJlY3Rpb24gKiBzdGVwLmRheXM7XHJcblxyXG4gICAgICAgIGNhbGN1bGF0ZUNhbGVuZGFyRGF0ZSA9IG5ldyBEYXRlKHllYXIsIG1vbnRoLCBkYXRlLCAxMiwgMCwgMCk7XHJcblxyXG4gICAgICAgIGlmIChtb2RlID09PSAnbW9udGgnKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGZpcnN0RGF5SW5OZXh0TW9udGggPSBuZXcgRGF0ZSh5ZWFyLCBtb250aCArIDEsIDEsIDEyLCAwLCAwKTtcclxuICAgICAgICAgICAgaWYgKGZpcnN0RGF5SW5OZXh0TW9udGguZ2V0VGltZSgpIDw9IGNhbGN1bGF0ZUNhbGVuZGFyRGF0ZS5nZXRUaW1lKCkpIHtcclxuICAgICAgICAgICAgICAgIGNhbGN1bGF0ZUNhbGVuZGFyRGF0ZSA9IG5ldyBEYXRlKGZpcnN0RGF5SW5OZXh0TW9udGguZ2V0VGltZSgpIC0gMjQgKiA2MCAqIDYwICogMTAwMCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGNhbGN1bGF0ZUNhbGVuZGFyRGF0ZTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRBZGphY2VudFZpZXdTdGFydFRpbWUoY29tcG9uZW50OiBJQ2FsZW5kYXJDb21wb25lbnQsIGRpcmVjdGlvbjogbnVtYmVyKTogRGF0ZSB7XHJcbiAgICAgICAgbGV0IGFkamFjZW50Q2FsZW5kYXJEYXRlID0gdGhpcy5nZXRBZGphY2VudENhbGVuZGFyRGF0ZShjb21wb25lbnQubW9kZSwgZGlyZWN0aW9uKTtcclxuICAgICAgICByZXR1cm4gY29tcG9uZW50LmdldFJhbmdlKGFkamFjZW50Q2FsZW5kYXJEYXRlKS5zdGFydFRpbWU7XHJcbiAgICB9XHJcblxyXG4gICAgcG9wdWxhdGVBZGphY2VudFZpZXdzKGNvbXBvbmVudDogSUNhbGVuZGFyQ29tcG9uZW50KSB7XHJcbiAgICAgICAgbGV0IGN1cnJlbnRWaWV3U3RhcnREYXRlOiBEYXRlLFxyXG4gICAgICAgICAgICBjdXJyZW50Vmlld0RhdGE6IElWaWV3W10sXHJcbiAgICAgICAgICAgIHRvVXBkYXRlVmlld0luZGV4OiBudW1iZXIsXHJcbiAgICAgICAgICAgIGN1cnJlbnRWaWV3SW5kZXggPSBjb21wb25lbnQuY3VycmVudFZpZXdJbmRleDtcclxuXHJcbiAgICAgICAgaWYgKGNvbXBvbmVudC5kaXJlY3Rpb24gPT09IDEpIHtcclxuICAgICAgICAgICAgY3VycmVudFZpZXdTdGFydERhdGUgPSB0aGlzLmdldEFkamFjZW50Vmlld1N0YXJ0VGltZShjb21wb25lbnQsIDEpO1xyXG4gICAgICAgICAgICB0b1VwZGF0ZVZpZXdJbmRleCA9IChjdXJyZW50Vmlld0luZGV4ICsgMSkgJSAzO1xyXG4gICAgICAgICAgICBjb21wb25lbnQudmlld3NbdG9VcGRhdGVWaWV3SW5kZXhdID0gY29tcG9uZW50LmdldFZpZXdEYXRhKGN1cnJlbnRWaWV3U3RhcnREYXRlKTtcclxuICAgICAgICB9IGVsc2UgaWYgKGNvbXBvbmVudC5kaXJlY3Rpb24gPT09IC0xKSB7XHJcbiAgICAgICAgICAgIGN1cnJlbnRWaWV3U3RhcnREYXRlID0gdGhpcy5nZXRBZGphY2VudFZpZXdTdGFydFRpbWUoY29tcG9uZW50LCAtMSk7XHJcbiAgICAgICAgICAgIHRvVXBkYXRlVmlld0luZGV4ID0gKGN1cnJlbnRWaWV3SW5kZXggKyAyKSAlIDM7XHJcbiAgICAgICAgICAgIGNvbXBvbmVudC52aWV3c1t0b1VwZGF0ZVZpZXdJbmRleF0gPSBjb21wb25lbnQuZ2V0Vmlld0RhdGEoY3VycmVudFZpZXdTdGFydERhdGUpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICghY29tcG9uZW50LnZpZXdzKSB7XHJcbiAgICAgICAgICAgICAgICBjdXJyZW50Vmlld0RhdGEgPSBbXTtcclxuICAgICAgICAgICAgICAgIGN1cnJlbnRWaWV3U3RhcnREYXRlID0gY29tcG9uZW50LnJhbmdlLnN0YXJ0VGltZTtcclxuICAgICAgICAgICAgICAgIGN1cnJlbnRWaWV3RGF0YS5wdXNoKGNvbXBvbmVudC5nZXRWaWV3RGF0YShjdXJyZW50Vmlld1N0YXJ0RGF0ZSkpO1xyXG4gICAgICAgICAgICAgICAgY3VycmVudFZpZXdTdGFydERhdGUgPSB0aGlzLmdldEFkamFjZW50Vmlld1N0YXJ0VGltZShjb21wb25lbnQsIDEpO1xyXG4gICAgICAgICAgICAgICAgY3VycmVudFZpZXdEYXRhLnB1c2goY29tcG9uZW50LmdldFZpZXdEYXRhKGN1cnJlbnRWaWV3U3RhcnREYXRlKSk7XHJcbiAgICAgICAgICAgICAgICBjdXJyZW50Vmlld1N0YXJ0RGF0ZSA9IHRoaXMuZ2V0QWRqYWNlbnRWaWV3U3RhcnRUaW1lKGNvbXBvbmVudCwgLTEpO1xyXG4gICAgICAgICAgICAgICAgY3VycmVudFZpZXdEYXRhLnB1c2goY29tcG9uZW50LmdldFZpZXdEYXRhKGN1cnJlbnRWaWV3U3RhcnREYXRlKSk7XHJcbiAgICAgICAgICAgICAgICBjb21wb25lbnQudmlld3MgPSBjdXJyZW50Vmlld0RhdGE7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjdXJyZW50Vmlld1N0YXJ0RGF0ZSA9IGNvbXBvbmVudC5yYW5nZS5zdGFydFRpbWU7XHJcbiAgICAgICAgICAgICAgICBjb21wb25lbnQudmlld3NbY3VycmVudFZpZXdJbmRleF0gPSBjb21wb25lbnQuZ2V0Vmlld0RhdGEoY3VycmVudFZpZXdTdGFydERhdGUpO1xyXG4gICAgICAgICAgICAgICAgY3VycmVudFZpZXdTdGFydERhdGUgPSB0aGlzLmdldEFkamFjZW50Vmlld1N0YXJ0VGltZShjb21wb25lbnQsIC0xKTtcclxuICAgICAgICAgICAgICAgIHRvVXBkYXRlVmlld0luZGV4ID0gKGN1cnJlbnRWaWV3SW5kZXggKyAyKSAlIDM7XHJcbiAgICAgICAgICAgICAgICBjb21wb25lbnQudmlld3NbdG9VcGRhdGVWaWV3SW5kZXhdID0gY29tcG9uZW50LmdldFZpZXdEYXRhKGN1cnJlbnRWaWV3U3RhcnREYXRlKTtcclxuICAgICAgICAgICAgICAgIGN1cnJlbnRWaWV3U3RhcnREYXRlID0gdGhpcy5nZXRBZGphY2VudFZpZXdTdGFydFRpbWUoY29tcG9uZW50LCAxKTtcclxuICAgICAgICAgICAgICAgIHRvVXBkYXRlVmlld0luZGV4ID0gKGN1cnJlbnRWaWV3SW5kZXggKyAxKSAlIDM7XHJcbiAgICAgICAgICAgICAgICBjb21wb25lbnQudmlld3NbdG9VcGRhdGVWaWV3SW5kZXhdID0gY29tcG9uZW50LmdldFZpZXdEYXRhKGN1cnJlbnRWaWV3U3RhcnREYXRlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBsb2FkRXZlbnRzKCkge1xyXG4gICAgICAgIHRoaXMuZXZlbnRTb3VyY2VDaGFuZ2VkLm5leHQoKTtcclxuICAgIH1cclxuXHJcbiAgICBzbGlkZShkaXJlY3Rpb246IG51bWJlcikge1xyXG4gICAgICAgIHRoaXMuc2xpZGVDaGFuZ2VkLm5leHQoZGlyZWN0aW9uKTtcclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGUoKSB7XHJcbiAgICAgICAgdGhpcy5zbGlkZVVwZGF0ZWQubmV4dCgpO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==