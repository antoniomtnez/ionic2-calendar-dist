import { __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
var CalendarService = /** @class */ (function () {
    function CalendarService() {
        this.currentDateChangedFromParent = new Subject();
        this.currentDateChangedFromChildren = new Subject();
        this.eventSourceChanged = new Subject();
        this.slideChanged = new Subject();
        this.slideUpdated = new Subject();
        this.currentDateChangedFromParent$ = this.currentDateChangedFromParent.asObservable();
        this.currentDateChangedFromChildren$ = this.currentDateChangedFromChildren.asObservable();
        this.eventSourceChanged$ = this.eventSourceChanged.asObservable();
        this.slideChanged$ = this.slideChanged.asObservable();
        this.slideUpdated$ = this.slideUpdated.asObservable();
    }
    CalendarService.prototype.setCurrentDate = function (val, fromParent) {
        if (fromParent === void 0) { fromParent = false; }
        this._currentDate = new Date(val);
        if (fromParent) {
            this.currentDateChangedFromParent.next(val);
        }
        else {
            this.currentDateChangedFromChildren.next(val);
        }
    };
    Object.defineProperty(CalendarService.prototype, "currentDate", {
        get: function () {
            return this._currentDate;
        },
        enumerable: true,
        configurable: true
    });
    CalendarService.prototype.rangeChanged = function (component) {
        if (this.queryMode === 'local') {
            if (component.eventSource && component.onDataLoaded) {
                component.onDataLoaded();
            }
        }
        else if (this.queryMode === 'remote') {
            var rangeStart = new Date(component.range.startTime.getTime()), rangeEnd = new Date(component.range.endTime.getTime());
            rangeStart.setHours(0);
            if (rangeStart.getHours() === 23) {
                rangeStart.setTime(rangeStart.getTime() + 3600000);
            }
            rangeEnd.setHours(0);
            if (rangeEnd.getHours() === 23) {
                rangeEnd.setTime(rangeEnd.getTime() + 3600000);
            }
            component.onRangeChanged.emit({
                startTime: rangeStart,
                endTime: rangeEnd
            });
        }
    };
    CalendarService.prototype.getStep = function (mode) {
        switch (mode) {
            case 'month':
                return {
                    years: 0,
                    months: 1,
                    days: 0
                };
            case 'week':
                return {
                    years: 0,
                    months: 0,
                    days: 7
                };
            case 'day':
                return {
                    years: 0,
                    months: 0,
                    days: 1
                };
        }
    };
    CalendarService.prototype.getAdjacentCalendarDate = function (mode, direction) {
        var calculateCalendarDate = this.currentDate;
        var step = this.getStep(mode), year = calculateCalendarDate.getFullYear() + direction * step.years, month = calculateCalendarDate.getMonth() + direction * step.months, date = calculateCalendarDate.getDate() + direction * step.days;
        calculateCalendarDate = new Date(year, month, date, 12, 0, 0);
        if (mode === 'month') {
            var firstDayInNextMonth = new Date(year, month + 1, 1, 12, 0, 0);
            if (firstDayInNextMonth.getTime() <= calculateCalendarDate.getTime()) {
                calculateCalendarDate = new Date(firstDayInNextMonth.getTime() - 24 * 60 * 60 * 1000);
            }
        }
        return calculateCalendarDate;
    };
    CalendarService.prototype.getAdjacentViewStartTime = function (component, direction) {
        var adjacentCalendarDate = this.getAdjacentCalendarDate(component.mode, direction);
        return component.getRange(adjacentCalendarDate).startTime;
    };
    CalendarService.prototype.populateAdjacentViews = function (component) {
        var currentViewStartDate, currentViewData, toUpdateViewIndex, currentViewIndex = component.currentViewIndex;
        if (component.direction === 1) {
            currentViewStartDate = this.getAdjacentViewStartTime(component, 1);
            toUpdateViewIndex = (currentViewIndex + 1) % 3;
            component.views[toUpdateViewIndex] = component.getViewData(currentViewStartDate);
        }
        else if (component.direction === -1) {
            currentViewStartDate = this.getAdjacentViewStartTime(component, -1);
            toUpdateViewIndex = (currentViewIndex + 2) % 3;
            component.views[toUpdateViewIndex] = component.getViewData(currentViewStartDate);
        }
        else {
            if (!component.views) {
                currentViewData = [];
                currentViewStartDate = component.range.startTime;
                currentViewData.push(component.getViewData(currentViewStartDate));
                currentViewStartDate = this.getAdjacentViewStartTime(component, 1);
                currentViewData.push(component.getViewData(currentViewStartDate));
                currentViewStartDate = this.getAdjacentViewStartTime(component, -1);
                currentViewData.push(component.getViewData(currentViewStartDate));
                component.views = currentViewData;
            }
            else {
                currentViewStartDate = component.range.startTime;
                component.views[currentViewIndex] = component.getViewData(currentViewStartDate);
                currentViewStartDate = this.getAdjacentViewStartTime(component, -1);
                toUpdateViewIndex = (currentViewIndex + 2) % 3;
                component.views[toUpdateViewIndex] = component.getViewData(currentViewStartDate);
                currentViewStartDate = this.getAdjacentViewStartTime(component, 1);
                toUpdateViewIndex = (currentViewIndex + 1) % 3;
                component.views[toUpdateViewIndex] = component.getViewData(currentViewStartDate);
            }
        }
    };
    CalendarService.prototype.loadEvents = function () {
        this.eventSourceChanged.next();
    };
    CalendarService.prototype.slide = function (direction) {
        this.slideChanged.next(direction);
    };
    CalendarService.prototype.update = function () {
        this.slideUpdated.next();
    };
    CalendarService = __decorate([
        Injectable()
    ], CalendarService);
    return CalendarService;
}());
export { CalendarService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FsZW5kYXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2lvbmljMi1jYWxlbmRhci8iLCJzb3VyY2VzIjpbImNhbGVuZGFyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDekMsT0FBTyxFQUFhLE9BQU8sRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUt6QztJQWVJO1FBTlEsaUNBQTRCLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUNuRCxtQ0FBOEIsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDO1FBQ3JELHVCQUFrQixHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7UUFDekMsaUJBQVksR0FBRyxJQUFJLE9BQU8sRUFBVSxDQUFDO1FBQ3JDLGlCQUFZLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUd2QyxJQUFJLENBQUMsNkJBQTZCLEdBQUcsSUFBSSxDQUFDLDRCQUE0QixDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ3RGLElBQUksQ0FBQywrQkFBK0IsR0FBRyxJQUFJLENBQUMsOEJBQThCLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDMUYsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNsRSxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDdEQsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQzFELENBQUM7SUFFRCx3Q0FBYyxHQUFkLFVBQWUsR0FBUyxFQUFFLFVBQTJCO1FBQTNCLDJCQUFBLEVBQUEsa0JBQTJCO1FBQ2pELElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbEMsSUFBSSxVQUFVLEVBQUU7WUFDWixJQUFJLENBQUMsNEJBQTRCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQy9DO2FBQU07WUFDSCxJQUFJLENBQUMsOEJBQThCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ2pEO0lBQ0wsQ0FBQztJQUVELHNCQUFJLHdDQUFXO2FBQWY7WUFDSSxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUM7UUFDN0IsQ0FBQzs7O09BQUE7SUFFRCxzQ0FBWSxHQUFaLFVBQWEsU0FBNkI7UUFDdEMsSUFBSSxJQUFJLENBQUMsU0FBUyxLQUFLLE9BQU8sRUFBRTtZQUM1QixJQUFJLFNBQVMsQ0FBQyxXQUFXLElBQUksU0FBUyxDQUFDLFlBQVksRUFBRTtnQkFDakQsU0FBUyxDQUFDLFlBQVksRUFBRSxDQUFDO2FBQzVCO1NBQ0o7YUFBTSxJQUFJLElBQUksQ0FBQyxTQUFTLEtBQUssUUFBUSxFQUFFO1lBQ3BDLElBQUksVUFBVSxHQUFHLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxDQUFDLEVBQzFELFFBQVEsR0FBRyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1lBRTNELFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdkIsSUFBSSxVQUFVLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxFQUFFO2dCQUM5QixVQUFVLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxPQUFPLENBQUMsQ0FBQzthQUN0RDtZQUVELFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDckIsSUFBSSxRQUFRLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxFQUFFO2dCQUM1QixRQUFRLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsR0FBRyxPQUFPLENBQUMsQ0FBQzthQUNsRDtZQUNELFNBQVMsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDO2dCQUMxQixTQUFTLEVBQUUsVUFBVTtnQkFDckIsT0FBTyxFQUFFLFFBQVE7YUFDcEIsQ0FBQyxDQUFDO1NBQ047SUFDTCxDQUFDO0lBRU8saUNBQU8sR0FBZixVQUFnQixJQUFrQjtRQUM5QixRQUFRLElBQUksRUFBRTtZQUNWLEtBQUssT0FBTztnQkFDUixPQUFPO29CQUNILEtBQUssRUFBRSxDQUFDO29CQUNSLE1BQU0sRUFBRSxDQUFDO29CQUNULElBQUksRUFBRSxDQUFDO2lCQUNWLENBQUM7WUFDTixLQUFLLE1BQU07Z0JBQ1AsT0FBTztvQkFDSCxLQUFLLEVBQUUsQ0FBQztvQkFDUixNQUFNLEVBQUUsQ0FBQztvQkFDVCxJQUFJLEVBQUUsQ0FBQztpQkFDVixDQUFDO1lBQ04sS0FBSyxLQUFLO2dCQUNOLE9BQU87b0JBQ0gsS0FBSyxFQUFFLENBQUM7b0JBQ1IsTUFBTSxFQUFFLENBQUM7b0JBQ1QsSUFBSSxFQUFFLENBQUM7aUJBQ1YsQ0FBQztTQUNUO0lBQ0wsQ0FBQztJQUVELGlEQUF1QixHQUF2QixVQUF3QixJQUFrQixFQUFFLFNBQWlCO1FBQ3pELElBQUkscUJBQXFCLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQztRQUM3QyxJQUFNLElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUMzQixJQUFJLEdBQUcscUJBQXFCLENBQUMsV0FBVyxFQUFFLEdBQUcsU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLEVBQ25FLEtBQUssR0FBRyxxQkFBcUIsQ0FBQyxRQUFRLEVBQUUsR0FBRyxTQUFTLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFDbEUsSUFBSSxHQUFHLHFCQUFxQixDQUFDLE9BQU8sRUFBRSxHQUFHLFNBQVMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBRW5FLHFCQUFxQixHQUFHLElBQUksSUFBSSxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFFOUQsSUFBSSxJQUFJLEtBQUssT0FBTyxFQUFFO1lBQ2xCLElBQU0sbUJBQW1CLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxFQUFFLEtBQUssR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDbkUsSUFBSSxtQkFBbUIsQ0FBQyxPQUFPLEVBQUUsSUFBSSxxQkFBcUIsQ0FBQyxPQUFPLEVBQUUsRUFBRTtnQkFDbEUscUJBQXFCLEdBQUcsSUFBSSxJQUFJLENBQUMsbUJBQW1CLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7YUFDekY7U0FDSjtRQUNELE9BQU8scUJBQXFCLENBQUM7SUFDakMsQ0FBQztJQUVELGtEQUF3QixHQUF4QixVQUF5QixTQUE2QixFQUFFLFNBQWlCO1FBQ3JFLElBQUksb0JBQW9CLEdBQUcsSUFBSSxDQUFDLHVCQUF1QixDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFDbkYsT0FBTyxTQUFTLENBQUMsUUFBUSxDQUFDLG9CQUFvQixDQUFDLENBQUMsU0FBUyxDQUFDO0lBQzlELENBQUM7SUFFRCwrQ0FBcUIsR0FBckIsVUFBc0IsU0FBNkI7UUFDL0MsSUFBSSxvQkFBMEIsRUFDMUIsZUFBd0IsRUFDeEIsaUJBQXlCLEVBQ3pCLGdCQUFnQixHQUFHLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQztRQUVsRCxJQUFJLFNBQVMsQ0FBQyxTQUFTLEtBQUssQ0FBQyxFQUFFO1lBQzNCLG9CQUFvQixHQUFHLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDbkUsaUJBQWlCLEdBQUcsQ0FBQyxnQkFBZ0IsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDL0MsU0FBUyxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxXQUFXLENBQUMsb0JBQW9CLENBQUMsQ0FBQztTQUNwRjthQUFNLElBQUksU0FBUyxDQUFDLFNBQVMsS0FBSyxDQUFDLENBQUMsRUFBRTtZQUNuQyxvQkFBb0IsR0FBRyxJQUFJLENBQUMsd0JBQXdCLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEUsaUJBQWlCLEdBQUcsQ0FBQyxnQkFBZ0IsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDL0MsU0FBUyxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxXQUFXLENBQUMsb0JBQW9CLENBQUMsQ0FBQztTQUNwRjthQUFNO1lBQ0gsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUU7Z0JBQ2xCLGVBQWUsR0FBRyxFQUFFLENBQUM7Z0JBQ3JCLG9CQUFvQixHQUFHLFNBQVMsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDO2dCQUNqRCxlQUFlLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxDQUFDO2dCQUNsRSxvQkFBb0IsR0FBRyxJQUFJLENBQUMsd0JBQXdCLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUNuRSxlQUFlLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxDQUFDO2dCQUNsRSxvQkFBb0IsR0FBRyxJQUFJLENBQUMsd0JBQXdCLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3BFLGVBQWUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUM7Z0JBQ2xFLFNBQVMsQ0FBQyxLQUFLLEdBQUcsZUFBZSxDQUFDO2FBQ3JDO2lCQUFNO2dCQUNILG9CQUFvQixHQUFHLFNBQVMsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDO2dCQUNqRCxTQUFTLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLEdBQUcsU0FBUyxDQUFDLFdBQVcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO2dCQUNoRixvQkFBb0IsR0FBRyxJQUFJLENBQUMsd0JBQXdCLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3BFLGlCQUFpQixHQUFHLENBQUMsZ0JBQWdCLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUMvQyxTQUFTLENBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLEdBQUcsU0FBUyxDQUFDLFdBQVcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO2dCQUNqRixvQkFBb0IsR0FBRyxJQUFJLENBQUMsd0JBQXdCLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUNuRSxpQkFBaUIsR0FBRyxDQUFDLGdCQUFnQixHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDL0MsU0FBUyxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxXQUFXLENBQUMsb0JBQW9CLENBQUMsQ0FBQzthQUNwRjtTQUNKO0lBQ0wsQ0FBQztJQUVELG9DQUFVLEdBQVY7UUFDSSxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDbkMsQ0FBQztJQUVELCtCQUFLLEdBQUwsVUFBTSxTQUFpQjtRQUNuQixJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRUQsZ0NBQU0sR0FBTjtRQUNJLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDN0IsQ0FBQztJQTFKUSxlQUFlO1FBRDNCLFVBQVUsRUFBRTtPQUNBLGVBQWUsQ0EySjNCO0lBQUQsc0JBQUM7Q0FBQSxBQTNKRCxJQTJKQztTQTNKWSxlQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHtPYnNlcnZhYmxlLCBTdWJqZWN0fSBmcm9tICdyeGpzJztcclxuXHJcbmltcG9ydCB7SUNhbGVuZGFyQ29tcG9uZW50LCBJVmlldywgQ2FsZW5kYXJNb2RlLCBRdWVyeU1vZGV9IGZyb20gJy4vY2FsZW5kYXInO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgQ2FsZW5kYXJTZXJ2aWNlIHtcclxuICAgIHF1ZXJ5TW9kZTogUXVlcnlNb2RlO1xyXG4gICAgY3VycmVudERhdGVDaGFuZ2VkRnJvbVBhcmVudCQ6IE9ic2VydmFibGU8RGF0ZT47XHJcbiAgICBjdXJyZW50RGF0ZUNoYW5nZWRGcm9tQ2hpbGRyZW4kOiBPYnNlcnZhYmxlPERhdGU+O1xyXG4gICAgZXZlbnRTb3VyY2VDaGFuZ2VkJDogT2JzZXJ2YWJsZTx2b2lkPjtcclxuICAgIHNsaWRlQ2hhbmdlZCQ6IE9ic2VydmFibGU8bnVtYmVyPjtcclxuICAgIHNsaWRlVXBkYXRlZCQ6IE9ic2VydmFibGU8dm9pZD47XHJcblxyXG4gICAgcHJpdmF0ZSBfY3VycmVudERhdGU6IERhdGU7XHJcbiAgICBwcml2YXRlIGN1cnJlbnREYXRlQ2hhbmdlZEZyb21QYXJlbnQgPSBuZXcgU3ViamVjdDxEYXRlPigpO1xyXG4gICAgcHJpdmF0ZSBjdXJyZW50RGF0ZUNoYW5nZWRGcm9tQ2hpbGRyZW4gPSBuZXcgU3ViamVjdDxEYXRlPigpO1xyXG4gICAgcHJpdmF0ZSBldmVudFNvdXJjZUNoYW5nZWQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xyXG4gICAgcHJpdmF0ZSBzbGlkZUNoYW5nZWQgPSBuZXcgU3ViamVjdDxudW1iZXI+KCk7XHJcbiAgICBwcml2YXRlIHNsaWRlVXBkYXRlZCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgdGhpcy5jdXJyZW50RGF0ZUNoYW5nZWRGcm9tUGFyZW50JCA9IHRoaXMuY3VycmVudERhdGVDaGFuZ2VkRnJvbVBhcmVudC5hc09ic2VydmFibGUoKTtcclxuICAgICAgICB0aGlzLmN1cnJlbnREYXRlQ2hhbmdlZEZyb21DaGlsZHJlbiQgPSB0aGlzLmN1cnJlbnREYXRlQ2hhbmdlZEZyb21DaGlsZHJlbi5hc09ic2VydmFibGUoKTtcclxuICAgICAgICB0aGlzLmV2ZW50U291cmNlQ2hhbmdlZCQgPSB0aGlzLmV2ZW50U291cmNlQ2hhbmdlZC5hc09ic2VydmFibGUoKTtcclxuICAgICAgICB0aGlzLnNsaWRlQ2hhbmdlZCQgPSB0aGlzLnNsaWRlQ2hhbmdlZC5hc09ic2VydmFibGUoKTtcclxuICAgICAgICB0aGlzLnNsaWRlVXBkYXRlZCQgPSB0aGlzLnNsaWRlVXBkYXRlZC5hc09ic2VydmFibGUoKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRDdXJyZW50RGF0ZSh2YWw6IERhdGUsIGZyb21QYXJlbnQ6IGJvb2xlYW4gPSBmYWxzZSkge1xyXG4gICAgICAgIHRoaXMuX2N1cnJlbnREYXRlID0gbmV3IERhdGUodmFsKTtcclxuICAgICAgICBpZiAoZnJvbVBhcmVudCkge1xyXG4gICAgICAgICAgICB0aGlzLmN1cnJlbnREYXRlQ2hhbmdlZEZyb21QYXJlbnQubmV4dCh2YWwpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuY3VycmVudERhdGVDaGFuZ2VkRnJvbUNoaWxkcmVuLm5leHQodmFsKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGN1cnJlbnREYXRlKCk6IERhdGUge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9jdXJyZW50RGF0ZTtcclxuICAgIH1cclxuXHJcbiAgICByYW5nZUNoYW5nZWQoY29tcG9uZW50OiBJQ2FsZW5kYXJDb21wb25lbnQpIHtcclxuICAgICAgICBpZiAodGhpcy5xdWVyeU1vZGUgPT09ICdsb2NhbCcpIHtcclxuICAgICAgICAgICAgaWYgKGNvbXBvbmVudC5ldmVudFNvdXJjZSAmJiBjb21wb25lbnQub25EYXRhTG9hZGVkKSB7XHJcbiAgICAgICAgICAgICAgICBjb21wb25lbnQub25EYXRhTG9hZGVkKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2UgaWYgKHRoaXMucXVlcnlNb2RlID09PSAncmVtb3RlJykge1xyXG4gICAgICAgICAgICBsZXQgcmFuZ2VTdGFydCA9IG5ldyBEYXRlKGNvbXBvbmVudC5yYW5nZS5zdGFydFRpbWUuZ2V0VGltZSgpKSxcclxuICAgICAgICAgICAgICAgIHJhbmdlRW5kID0gbmV3IERhdGUoY29tcG9uZW50LnJhbmdlLmVuZFRpbWUuZ2V0VGltZSgpKTtcclxuXHJcbiAgICAgICAgICAgIHJhbmdlU3RhcnQuc2V0SG91cnMoMCk7XHJcbiAgICAgICAgICAgIGlmIChyYW5nZVN0YXJ0LmdldEhvdXJzKCkgPT09IDIzKSB7XHJcbiAgICAgICAgICAgICAgICByYW5nZVN0YXJ0LnNldFRpbWUocmFuZ2VTdGFydC5nZXRUaW1lKCkgKyAzNjAwMDAwKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmFuZ2VFbmQuc2V0SG91cnMoMCk7XHJcbiAgICAgICAgICAgIGlmIChyYW5nZUVuZC5nZXRIb3VycygpID09PSAyMykge1xyXG4gICAgICAgICAgICAgICAgcmFuZ2VFbmQuc2V0VGltZShyYW5nZUVuZC5nZXRUaW1lKCkgKyAzNjAwMDAwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb21wb25lbnQub25SYW5nZUNoYW5nZWQuZW1pdCh7XHJcbiAgICAgICAgICAgICAgICBzdGFydFRpbWU6IHJhbmdlU3RhcnQsXHJcbiAgICAgICAgICAgICAgICBlbmRUaW1lOiByYW5nZUVuZFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRTdGVwKG1vZGU6IENhbGVuZGFyTW9kZSk6IHsgeWVhcnM6IG51bWJlcjsgbW9udGhzOiBudW1iZXI7IGRheXM6IG51bWJlcjsgfSB7XHJcbiAgICAgICAgc3dpdGNoIChtb2RlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgJ21vbnRoJzpcclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgeWVhcnM6IDAsXHJcbiAgICAgICAgICAgICAgICAgICAgbW9udGhzOiAxLFxyXG4gICAgICAgICAgICAgICAgICAgIGRheXM6IDBcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIGNhc2UgJ3dlZWsnOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICB5ZWFyczogMCxcclxuICAgICAgICAgICAgICAgICAgICBtb250aHM6IDAsXHJcbiAgICAgICAgICAgICAgICAgICAgZGF5czogN1xyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgY2FzZSAnZGF5JzpcclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgeWVhcnM6IDAsXHJcbiAgICAgICAgICAgICAgICAgICAgbW9udGhzOiAwLFxyXG4gICAgICAgICAgICAgICAgICAgIGRheXM6IDFcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGdldEFkamFjZW50Q2FsZW5kYXJEYXRlKG1vZGU6IENhbGVuZGFyTW9kZSwgZGlyZWN0aW9uOiBudW1iZXIpOiBEYXRlIHtcclxuICAgICAgICBsZXQgY2FsY3VsYXRlQ2FsZW5kYXJEYXRlID0gdGhpcy5jdXJyZW50RGF0ZTtcclxuICAgICAgICBjb25zdCBzdGVwID0gdGhpcy5nZXRTdGVwKG1vZGUpLFxyXG4gICAgICAgICAgICB5ZWFyID0gY2FsY3VsYXRlQ2FsZW5kYXJEYXRlLmdldEZ1bGxZZWFyKCkgKyBkaXJlY3Rpb24gKiBzdGVwLnllYXJzLFxyXG4gICAgICAgICAgICBtb250aCA9IGNhbGN1bGF0ZUNhbGVuZGFyRGF0ZS5nZXRNb250aCgpICsgZGlyZWN0aW9uICogc3RlcC5tb250aHMsXHJcbiAgICAgICAgICAgIGRhdGUgPSBjYWxjdWxhdGVDYWxlbmRhckRhdGUuZ2V0RGF0ZSgpICsgZGlyZWN0aW9uICogc3RlcC5kYXlzO1xyXG5cclxuICAgICAgICBjYWxjdWxhdGVDYWxlbmRhckRhdGUgPSBuZXcgRGF0ZSh5ZWFyLCBtb250aCwgZGF0ZSwgMTIsIDAsIDApO1xyXG5cclxuICAgICAgICBpZiAobW9kZSA9PT0gJ21vbnRoJykge1xyXG4gICAgICAgICAgICBjb25zdCBmaXJzdERheUluTmV4dE1vbnRoID0gbmV3IERhdGUoeWVhciwgbW9udGggKyAxLCAxLCAxMiwgMCwgMCk7XHJcbiAgICAgICAgICAgIGlmIChmaXJzdERheUluTmV4dE1vbnRoLmdldFRpbWUoKSA8PSBjYWxjdWxhdGVDYWxlbmRhckRhdGUuZ2V0VGltZSgpKSB7XHJcbiAgICAgICAgICAgICAgICBjYWxjdWxhdGVDYWxlbmRhckRhdGUgPSBuZXcgRGF0ZShmaXJzdERheUluTmV4dE1vbnRoLmdldFRpbWUoKSAtIDI0ICogNjAgKiA2MCAqIDEwMDApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBjYWxjdWxhdGVDYWxlbmRhckRhdGU7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0QWRqYWNlbnRWaWV3U3RhcnRUaW1lKGNvbXBvbmVudDogSUNhbGVuZGFyQ29tcG9uZW50LCBkaXJlY3Rpb246IG51bWJlcik6IERhdGUge1xyXG4gICAgICAgIGxldCBhZGphY2VudENhbGVuZGFyRGF0ZSA9IHRoaXMuZ2V0QWRqYWNlbnRDYWxlbmRhckRhdGUoY29tcG9uZW50Lm1vZGUsIGRpcmVjdGlvbik7XHJcbiAgICAgICAgcmV0dXJuIGNvbXBvbmVudC5nZXRSYW5nZShhZGphY2VudENhbGVuZGFyRGF0ZSkuc3RhcnRUaW1lO1xyXG4gICAgfVxyXG5cclxuICAgIHBvcHVsYXRlQWRqYWNlbnRWaWV3cyhjb21wb25lbnQ6IElDYWxlbmRhckNvbXBvbmVudCkge1xyXG4gICAgICAgIGxldCBjdXJyZW50Vmlld1N0YXJ0RGF0ZTogRGF0ZSxcclxuICAgICAgICAgICAgY3VycmVudFZpZXdEYXRhOiBJVmlld1tdLFxyXG4gICAgICAgICAgICB0b1VwZGF0ZVZpZXdJbmRleDogbnVtYmVyLFxyXG4gICAgICAgICAgICBjdXJyZW50Vmlld0luZGV4ID0gY29tcG9uZW50LmN1cnJlbnRWaWV3SW5kZXg7XHJcblxyXG4gICAgICAgIGlmIChjb21wb25lbnQuZGlyZWN0aW9uID09PSAxKSB7XHJcbiAgICAgICAgICAgIGN1cnJlbnRWaWV3U3RhcnREYXRlID0gdGhpcy5nZXRBZGphY2VudFZpZXdTdGFydFRpbWUoY29tcG9uZW50LCAxKTtcclxuICAgICAgICAgICAgdG9VcGRhdGVWaWV3SW5kZXggPSAoY3VycmVudFZpZXdJbmRleCArIDEpICUgMztcclxuICAgICAgICAgICAgY29tcG9uZW50LnZpZXdzW3RvVXBkYXRlVmlld0luZGV4XSA9IGNvbXBvbmVudC5nZXRWaWV3RGF0YShjdXJyZW50Vmlld1N0YXJ0RGF0ZSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChjb21wb25lbnQuZGlyZWN0aW9uID09PSAtMSkge1xyXG4gICAgICAgICAgICBjdXJyZW50Vmlld1N0YXJ0RGF0ZSA9IHRoaXMuZ2V0QWRqYWNlbnRWaWV3U3RhcnRUaW1lKGNvbXBvbmVudCwgLTEpO1xyXG4gICAgICAgICAgICB0b1VwZGF0ZVZpZXdJbmRleCA9IChjdXJyZW50Vmlld0luZGV4ICsgMikgJSAzO1xyXG4gICAgICAgICAgICBjb21wb25lbnQudmlld3NbdG9VcGRhdGVWaWV3SW5kZXhdID0gY29tcG9uZW50LmdldFZpZXdEYXRhKGN1cnJlbnRWaWV3U3RhcnREYXRlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAoIWNvbXBvbmVudC52aWV3cykge1xyXG4gICAgICAgICAgICAgICAgY3VycmVudFZpZXdEYXRhID0gW107XHJcbiAgICAgICAgICAgICAgICBjdXJyZW50Vmlld1N0YXJ0RGF0ZSA9IGNvbXBvbmVudC5yYW5nZS5zdGFydFRpbWU7XHJcbiAgICAgICAgICAgICAgICBjdXJyZW50Vmlld0RhdGEucHVzaChjb21wb25lbnQuZ2V0Vmlld0RhdGEoY3VycmVudFZpZXdTdGFydERhdGUpKTtcclxuICAgICAgICAgICAgICAgIGN1cnJlbnRWaWV3U3RhcnREYXRlID0gdGhpcy5nZXRBZGphY2VudFZpZXdTdGFydFRpbWUoY29tcG9uZW50LCAxKTtcclxuICAgICAgICAgICAgICAgIGN1cnJlbnRWaWV3RGF0YS5wdXNoKGNvbXBvbmVudC5nZXRWaWV3RGF0YShjdXJyZW50Vmlld1N0YXJ0RGF0ZSkpO1xyXG4gICAgICAgICAgICAgICAgY3VycmVudFZpZXdTdGFydERhdGUgPSB0aGlzLmdldEFkamFjZW50Vmlld1N0YXJ0VGltZShjb21wb25lbnQsIC0xKTtcclxuICAgICAgICAgICAgICAgIGN1cnJlbnRWaWV3RGF0YS5wdXNoKGNvbXBvbmVudC5nZXRWaWV3RGF0YShjdXJyZW50Vmlld1N0YXJ0RGF0ZSkpO1xyXG4gICAgICAgICAgICAgICAgY29tcG9uZW50LnZpZXdzID0gY3VycmVudFZpZXdEYXRhO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY3VycmVudFZpZXdTdGFydERhdGUgPSBjb21wb25lbnQucmFuZ2Uuc3RhcnRUaW1lO1xyXG4gICAgICAgICAgICAgICAgY29tcG9uZW50LnZpZXdzW2N1cnJlbnRWaWV3SW5kZXhdID0gY29tcG9uZW50LmdldFZpZXdEYXRhKGN1cnJlbnRWaWV3U3RhcnREYXRlKTtcclxuICAgICAgICAgICAgICAgIGN1cnJlbnRWaWV3U3RhcnREYXRlID0gdGhpcy5nZXRBZGphY2VudFZpZXdTdGFydFRpbWUoY29tcG9uZW50LCAtMSk7XHJcbiAgICAgICAgICAgICAgICB0b1VwZGF0ZVZpZXdJbmRleCA9IChjdXJyZW50Vmlld0luZGV4ICsgMikgJSAzO1xyXG4gICAgICAgICAgICAgICAgY29tcG9uZW50LnZpZXdzW3RvVXBkYXRlVmlld0luZGV4XSA9IGNvbXBvbmVudC5nZXRWaWV3RGF0YShjdXJyZW50Vmlld1N0YXJ0RGF0ZSk7XHJcbiAgICAgICAgICAgICAgICBjdXJyZW50Vmlld1N0YXJ0RGF0ZSA9IHRoaXMuZ2V0QWRqYWNlbnRWaWV3U3RhcnRUaW1lKGNvbXBvbmVudCwgMSk7XHJcbiAgICAgICAgICAgICAgICB0b1VwZGF0ZVZpZXdJbmRleCA9IChjdXJyZW50Vmlld0luZGV4ICsgMSkgJSAzO1xyXG4gICAgICAgICAgICAgICAgY29tcG9uZW50LnZpZXdzW3RvVXBkYXRlVmlld0luZGV4XSA9IGNvbXBvbmVudC5nZXRWaWV3RGF0YShjdXJyZW50Vmlld1N0YXJ0RGF0ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbG9hZEV2ZW50cygpIHtcclxuICAgICAgICB0aGlzLmV2ZW50U291cmNlQ2hhbmdlZC5uZXh0KCk7XHJcbiAgICB9XHJcblxyXG4gICAgc2xpZGUoZGlyZWN0aW9uOiBudW1iZXIpIHtcclxuICAgICAgICB0aGlzLnNsaWRlQ2hhbmdlZC5uZXh0KGRpcmVjdGlvbik7XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlKCkge1xyXG4gICAgICAgIHRoaXMuc2xpZGVVcGRhdGVkLm5leHQoKTtcclxuICAgIH1cclxufVxyXG4iXX0=